{
    "code": "import requests\nfrom bs4 import BeautifulSoup\nimport pandas as pd\nimport os\n\noutput_dir = 'uploads/29f6aef6-9c01-4ff8-a545-357d63c597e3'\nos.makedirs(output_dir, exist_ok=True)\n\nurl = 'https://en.wikipedia.org/wiki/List_of_highest-grossing_films'\nresponse = requests.get(url)\nresponse.raise_for_status()\n\nsoup = BeautifulSoup(response.text, 'html.parser')\n\ntables = soup.find_all('table', {'class': 'wikitable sortable'})\n\ndata = []\nheaders = []\n\n# Assuming the first table is the main one for highest-grossing films\nif tables:\n    table = tables[0]\n    # Extract headers\n    header_row = table.find('tr')\n    if header_row:\n        headers = [th.get_text(strip=True) for th in header_row.find_all('th')]\n\n    # Extract rows\n    for row in table.find_all('tr')[1:]:\n        cells = row.find_all(['td', 'th'])\n        row_data = [cell.get_text(strip=True) for cell in cells]\n        data.append(row_data)\n\ndf = pd.DataFrame(data, columns=headers)\n\n# Clean column names\ndf.columns = df.columns.str.replace(r'\\[.*?\\]', '', regex=True).str.strip()\ndf.columns = df.columns.str.replace(r'\\n', '', regex=True).str.strip()\n\n# Rename columns for easier access, if necessary, based on expected data (Rank, Peak, Worldwide gross, Year)\ndf.rename(columns={'Rank': 'Rank', 'Worldwide gross': 'Worldwide_gross', 'Year': 'Year', 'Peak': 'Peak'}, inplace=True)\n\n# Drop rows where 'Worldwide_gross' is empty or doesn't look like a number, or if it's a 'Notes' row\ndf = df[df['Worldwide_gross'].str.contains('$', na=False)]\n\ndf['Worldwide_gross'] = df['Worldwide_gross'].replace({r'\\$': '', r'\\,': '', r'billion': '000000000', r'million': '000000'}, regex=True).astype(float)\n\n# Convert Year to integer, handling potential errors if year is not clean\ndf['Year'] = pd.to_numeric(df['Year'], errors='coerce')\ndf.dropna(subset=['Year'], inplace=True)\ndf['Year'] = df['Year'].astype(int)\n\n# Convert Rank and Peak to numeric, coercing errors to NaN\ndf['Rank'] = pd.to_numeric(df['Rank'], errors='coerce')\ndf['Peak'] = pd.to_numeric(df['Peak'], errors='coerce')\n\ndf.to_csv(os.path.join(output_dir, 'data.csv'), index=False)\n\n# Generate metadata\nwith open(os.path.join(output_dir, 'metadata.txt'), 'w') as f:\n    f.write('Scraped Data from Wikipedia - List of Highest-Grossing Films\\n\\n')\n    f.write('File: data.csv\\n')\n    f.write('Description: Contains a table of highest-grossing films with columns like Rank, Worldwide gross, Year, Peak, etc.\\n\\n')\n    f.write('DataFrame Info:\\n')\n    df.info(buf=f)\n    f.write('\\n\\nDataFrame Columns:\\n')\n    f.write(str(df.columns.tolist()))\n    f.write('\\n\\nDataFrame Head:\\n')\n    f.write(df.head().to_string())\n    f.write('\\n\\nExpected JSON Answer Format:\\n')\n    f.write('[\"Answer to Q1\", \"Answer to Q2\", \"data:image/png;base64,...\"]\\n')\n\n",
    "libraries": [
        "requests",
        "beautifulsoup4",
        "pandas"
    ],
    "questions": [
        "How many $2 bn movies were released before 2000?",
        "Which is the earliest film that grossed over $1.5 bn?",
        "What's the correlation between the Rank and Peak?",
        "Draw a scatterplot of Rank and Peak along with a dotted red regression line through it."
    ],
    "comment": "Step-3: Getting scrap code and metadata from llm. Tries count = %d 0"
}{
    "code": "import requests\nimport pandas as pd\nimport os\nimport io\nimport re\n\n# Define paths\noutput_dir = \"uploads/29f6aef6-9c01-4ff8-a545-357d63c597e3\"\ndata_path = os.path.join(output_dir, \"data.csv\")\nmetadata_path = os.path.join(output_dir, \"metadata.txt\")\n\n# Create directory if it doesn't exist\nos.makedirs(output_dir, exist_ok=True)\n\n# Scrape the data\nurl = \"https://en.wikipedia.org/wiki/List_of_highest-grossing_films\"\n\n# Use pd.read_html to directly parse tables from the URL\ntables = pd.read_html(url)\n\n# Identify the correct table. The table for highest-grossing films typically has 'Rank', 'Title', 'Worldwide gross', 'Year'.\ndf = None\nfor table in tables:\n    # Check if 'Worldwide gross' is in any of the column headers (case-insensitive, ignoring variations)\n    normalized_cols = [re.sub(r'\\[.*?\\]', '', str(col)).strip().lower() for col in table.columns]\n    if 'worldwide gross' in normalized_cols:\n        df = table\n        break\n\nif df is None:\n    raise ValueError(\"Could not find the table containing 'Worldwide gross' column.\")\n\n# Clean up column names generally\n# Remove reference notes (e.g., [A]), strip whitespace, and replace spaces with underscores.\ndf.columns = [re.sub(r'\\[.*?\\]', '', str(col)).strip().replace(' ', '_').replace('.', '') for col in df.columns]\n\n# Clean and convert 'Worldwide_gross' to numeric\nif 'Worldwide_gross' in df.columns:\n    # Remove '$' and commas, then convert to float\n    df['Worldwide_gross'] = df['Worldwide_gross'].astype(str).str.replace('$', '', regex=False).str.replace(',', '', regex=False)\n    # Handle potential non-numeric values after cleaning\n    df['Worldwide_gross'] = pd.to_numeric(df['Worldwide_gross'], errors='coerce')\n    # Drop rows where Worldwide_gross became NaN after conversion, as they are not valid film entries for analysis\n    df.dropna(subset=['Worldwide_gross'], inplace=True)\nelse:\n    raise KeyError(\"The 'Worldwide_gross' column could not be found or processed correctly after scraping and cleaning.\")\n\n# Clean and convert 'Year' to numeric\nif 'Year' in df.columns:\n    # Extract four digits that represent the year\n    df['Year'] = df['Year'].astype(str).str.extract(r'(\\d{4})')[0]\n    df['Year'] = pd.to_numeric(df['Year'], errors='coerce')\n    df.dropna(subset=['Year'], inplace=True)\n    df['Year'] = df['Year'].astype(int)\nelse:\n    raise KeyError(\"The 'Year' column could not be found or processed correctly after scraping and cleaning.\")\n\n# Clean and convert 'Rank' and 'Peak' to numeric\nfor col_name in ['Rank', 'Peak']:\n    if col_name in df.columns:\n        df[col_name] = df[col_name].astype(str).str.extract(r'(\\d+)')[0] # Extract digits\n        df[col_name] = pd.to_numeric(df[col_name], errors='coerce')\n        df.dropna(subset=[col_name], inplace=True)\n        df[col_name] = df[col_name].astype(int)\n\n# Ensure 'Title' column exists as it's needed for one of the questions\nif 'Title' not in df.columns:\n    raise KeyError(\"The 'Title' column was not found after scraping and cleaning.\")\n\n# Save the cleaned DataFrame to CSV\ndf.to_csv(data_path, index=False)\n\n# Generate metadata\nmetadata_content = io.StringIO()\nmetadata_content.write(f\"--- Metadata for scraped data ---\\n\\n\")\nmetadata_content.write(f\"Source URL: {url}\\n\\n\")\nmetadata_content.write(f\"Data saved to: {data_path}\\n\\n\")\nmetadata_content.write(f\"Description: This CSV file contains a list of highest-grossing films scraped from Wikipedia, including Rank, Peak, Title, Worldwide gross, and Year. Columns have been cleaned and converted to appropriate data types for analysis.\\n\\n\")\n\nmetadata_content.write(f\"DataFrame Info:\\n\")\ndf.info(buf=metadata_content)\nmetadata_content.write(f\"\\n\")\n\nmetadata_content.write(f\"DataFrame Columns:\\n\")\nmetadata_content.write(str(df.columns.tolist()) + \"\\n\\n\")\n\nmetadata_content.write(f\"DataFrame Head (first 5 rows):\\n\")\nmetadata_content.write(df.head().to_string() + \"\\n\\n\")\n\nmetadata_content.write(f\"Expected JSON answer format for the questions:\\n\")\nmetadata_content.write(r\"\"\"[\n  {\n    \"question\": \"How many $2 bn movies were released before 2000?\",\n    \"answer\": \"integer\"\n  },\n  {\n    \"question\": \"Which is the earliest film that grossed over $1.5 bn?\",\n    \"answer\": \"string (film title)\"\n  },\n  {\n    \"question\": \"What's the correlation between the Rank and Peak?\",\n    \"answer\": \"float\"\n  },\n  {\n    \"question\": \"Draw a scatterplot of Rank and Peak along with a dotted red regression line through it.\",\n    \"answer\": \"data:image/png;base64,iVBORw0KG...\"\n  }\n]\"\"\")\n\nwith open(metadata_path, 'w') as f:\n    f.write(metadata_content.getvalue())\n",
    "libraries": [
        "pandas",
        "requests"
    ],
    "questions": [
        "How many $2 bn movies were released before 2000?",
        "Which is the earliest film that grossed over $1.5 bn?",
        "What's the correlation between the Rank and Peak?",
        "Draw a scatterplot of Rank and Peak along with a dotted red regression line through it."
    ],
    "comment": "Step-4: Error occured while scrapping. Tries count = %d, 0"
}